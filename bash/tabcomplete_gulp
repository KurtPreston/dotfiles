# Gulp tab completion for bash
# This provides tab completion for gulp tasks by running `gulp -T` in the background

# Function to get cached gulp tasks using shared script
_get_gulp_tasks() {
    "$HOME/.dotfiles/bin/gulp-get-tasks"
}

# Main completion function for gulp
_gulp_completion() {
    local cur="${COMP_WORDS[COMP_CWORD]}"
    local prev="${COMP_WORDS[COMP_CWORD-1]}"
    
    # Only provide task completion for the first argument after 'gulp'
    # or when the previous argument is a gulp option that expects a task
    if [[ $COMP_CWORD -eq 1 ]] || [[ "$prev" =~ ^--(task|series|parallel)$ ]]; then
        local tasks
        tasks=$(_get_gulp_tasks)
        
        if [[ -n "$tasks" ]]; then
            COMPREPLY=($(compgen -W "$tasks" -- "$cur"))
        fi
    else
        # For other positions, provide file completion as fallback
        COMPREPLY=($(compgen -f -- "$cur"))
    fi
}

# Function to clean old cache files using shared script
_clean_gulp_cache() {
    "$HOME/.dotfiles/bin/gulp-clean-cache"
}

# Register completion for gulp command
complete -F _gulp_completion gulp

# Clean old cache files when this script is sourced (runs once per shell session)
_clean_gulp_cache
