# Gulp tab completion for zsh
# This provides tab completion for gulp tasks by running `gulp -T` in the background

# Function to get cached gulp tasks using shared script
_get_gulp_tasks() {
    "$HOME/.dotfiles/bin/gulp-get-tasks"
}

# Main completion function for gulp
_gulp_completion() {
    local -a tasks
    local context state line
    
    _arguments -C \
        '1: :->tasks' \
        '*: :->args'
    
    case $state in
        tasks)
            # Get gulp tasks and create completion array
            local task_list
            task_list=$(_get_gulp_tasks)
            
            if [[ -n "$task_list" ]]; then
                # Convert newline-separated tasks to array
                tasks=(${(f)task_list})
                _describe 'gulp tasks' tasks
            fi
            ;;
        args)
            # For additional arguments, provide file completion as fallback
            _files
            ;;
    esac
}

# Function to clean old cache files using shared script
_clean_gulp_cache() {
    "$HOME/.dotfiles/bin/gulp-clean-cache"
}

# Register completion for gulp command
compdef _gulp_completion gulp

# Clean old cache files when this script is sourced (runs once per shell session)
_clean_gulp_cache
