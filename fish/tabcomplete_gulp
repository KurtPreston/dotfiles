# Gulp tab completion for fish
# This provides tab completion for gulp tasks by running `gulp -T` in the background

# Function to get cached gulp tasks using shared script
function __get_gulp_tasks
    "$HOME/.dotfiles/bin/gulp-get-tasks"
end

# Main completion function for gulp
function __gulp_complete
    set -l cmd (commandline -opc)
    set -l current (commandline -ct)
    
    # Only provide task completion for the first argument after 'gulp'
    # or when the previous argument is a gulp option that expects a task
    if test (count $cmd) -eq 1
        or string match -q -- "--task" $cmd[-1]
        or string match -q -- "--series" $cmd[-1]
        or string match -q -- "--parallel" $cmd[-1]
        
        set -l tasks (__get_gulp_tasks)
        
        if test -n "$tasks"
            for task in $tasks
                echo $task
            end
        end
    end
end

# Function to clean old cache files using shared script
function __clean_gulp_cache
    "$HOME/.dotfiles/bin/gulp-clean-cache"
end

# Register completion for gulp command
complete -c gulp -f -a "(__gulp_complete)" -d "Gulp task"

# Clean old cache files when this script is sourced (runs once per shell session)
__clean_gulp_cache
